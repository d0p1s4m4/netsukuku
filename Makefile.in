# This file is part of Netsukuku
# (c) Copyright 2021 d0p1 <contact@d0p1.eu>
#
# This source code is free software; you can redistribute it and/or
# modify it under the terms of the GNU Public License as published 
# by the Free Software Foundation; either version 2 of the License,
# or (at your option) any later version.
#
# This source code is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# Please refer to the GNU Public License for more details.
#
# You should have received a copy of the GNU Public License along with
# this source code; if not, write to:
# Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

CC	?= gcc
RM	= rm -f

CFLAGS	+= %(CFLAGS) -Wall -Wextra -Isrc/ -Iinclude
LDFLAGS	+= %(LDFLAGS) -lgmp -lpthread -lcrypto -lz

SRCS_COMMON	= buffer.c endianness.c log.c misc.c xmalloc.c
SRCS_QSPN	= qspn-empiric.c
SRCS_NETSUKUKU	= accept.c andna.c andna_cache.c andns.c andns_lib.c \
					andns_net.c andns_snsd.c bmap.c conf.c crypto.c \
					daemon.c dns_wrapper.c dnslib.c err_errno.c gmap.c \
					hash.c hook.c if.c igs.c inet.c iptunnel.c ipv6-gmp.c \
					krnl_route.c krnl_rule.c libiptc/libip4tc.c libnetlink.c \
					libping.c ll_map.c llist.c map.c mark.c netsukuku.c \
					ntk-console-server.c pkts.c qspn.c radar.c rehook.c \
					request.c route.c snsd_cache.c tracer.c
SRCS_NTKRESOLV	= andns_lib.c andns_net.c crypto.c snsd_cache.c inet.c \
					ll_map.c libnetlink.c err_errno.c ntkresolv.c
SRCS_NTKCONSOLE	= ntkconsole/main.c ntkconsole/cmd.c ntkconsole/request.c
SRCS_TEST		= test_common.c test_buffer.c test_misc.c

OBJS_COMMON	= $(addprefix src/, $(SRCS_COMMON:.c=.o))
OBJS_QSPN	= $(addprefix src/, $(SRCS_QSPN:.c=.o))
OBJS_NETSUKUKU	= $(addprefix src/, $(SRCS_NETSUKUKU:.c=.o))
OBJS_NTKRESOLV	= $(addprefix src/, $(SRCS_NTKRESOLV:.c=.o))
OBJS_NTKCONSOLE	= $(addprefix src/, $(SRCS_NTKCONSOLE:.c=.o))
OBJS_TEST		= $(addprefix test/, $(SRCS_TEST:.c=.o))
OBJS	= $(OBJS_QSPN) $(OBJS_NETSUKUKU) $(OBJS_NTKCONSOLE) $(OBJS_NTKRESOLV) \
			$(OBJS_COMMON) $(OBJS_TEST)

test: CFLAGS	+= --coverage
test: LDFLAGS	+= -lcmocka --coverage
test: CC		:= gcc

all: ntkd ntkresolv ntkconsole qspn-empiric

ntkd: $(OBJS_NETSUKUKU) $(OBJS_COMMON)
	$(CC) -o $@ $^ $(LDFLAGS)

ntkresolv: $(OBJS_NTKRESOLV) $(OBJS_COMMON)
	$(CC) -o $@ $^ $(LDFLAGS)

ntkconsole: $(OBJS_NTKCONSOLE)
	$(CC) -o $@ $^ $(LDFLAGS) -lreadline -ljson-c

qspn-empiric: $(OBJS_QSPN) $(OBJS_COMMON)
	$(CC) -o $@ $^ $(LDFLAGS)

test: $(OBJS_TEST) $(OBJS_COMMON)
	$(CC) -o unittest $^ $(LDFLAGS)
	@./unittest

%.o: %.c
	$(CC) $(CFLAGS) -c -o $@ $<

clean:
	$(RM) ntkd ntkresolv ntkconsole qspn-empiric unittest
	$(RM) $(OBJS)
	$(RM) $(OBJS:.o=.gcda)
	$(RM) $(OBJS:.o=.gcno)

re: clean all

install:
	install -d %(SYSROOT)%(DATA_DIR)

	install -d %(SYSROOT)%(CONF_DIR)
	install meta/conf/netsukuku.conf %(SYSROOT)%(CONF_DIR)
	install meta/conf/andna_hostnames %(SYSROOT)%(CONF_DIR)
	install meta/conf/snsd_nodes %(SYSROOT)%(CONF_DIR)
	install meta/scripts/ip_masquerade.sh %(SYSROOT)%(CONF_DIR)
	install meta/scripts/rc.ntk %(SYSROOT)%(CONF_DIR)
	install meta/scripts/tc_shaper.sh %(SYSROOT)%(CONF_DIR)

	install -d %(SYSROOT)%(MAN_DIR)/main8
	install -d %(SYSROOT)%(MAN_DIR)/main4
	install meta/man/ntkd.8 %(SYSROOT)%(MAN_DIR)/man8
	install meta/man/ntk-wifi.8 %(SYSROOT)%(MAN_DIR)/man8
	install meta/man/ntk-resolv.8 %(SYSROOT)%(MAN_DIR)/man8
	install meta/man/andna.8 %(SYSROOT)%(MAN_DIR)/man8
	install meta/man/netsukuku.conf.5 %(SYSROOT)%(MAN_DIR)/man5

	install -d %(SYSROOT)%(BIN_DIR)
	install src/scripts/ntk-wifi %(SYSROOT)%(BIN_DIR)
	install ntkd %(SYSROOT)%(BIN_DIR)
	install ntkresolv %(SYSROOT)%(BIN_DIR)
	install ntkconsole %(SYSROOT)%(BIN_DIR)

.PHONY: all test clean re install
